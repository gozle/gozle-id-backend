# Gozle ID
The OAuth2 provider and REST Api for Gozle ID.

## 1. Client Registration
New application Client can be registered at https://i.gozle.com.tm/o/admin/applications

Create database document for Client with fields:
  ```
  Client:
    callback_uri - example: https://mysite.com/api/auth/callback
    
    login_uri - https://id.gozle.com.tm/api/auth
    token_uri - https://i.gozle.com.tm/o/token
    resource_uri - https://i.gozle.com.tm/api/resource
    
    access_token - Token to work with RestAPI
    refresh_token - Token to refresh access_token
  ```

Extract and save _client_id_ and _client_secret_ to database.

## 2. The Authorization Request
Clients will direct a user’s browser to the authorization server to begin the OAuth process.

The client creates a "_code_verifier_" for each Authorization Request, in the following manner:
  ```
  code_verifier = high-entropy cryptographic random STRING
    using the unreserved characters [A-Z] / [a-z] / [0-9] / "-" / "." / "_" / "~"
    with a minimum length of 43 characters and a maximum length of 128 characters
  ```

The client then creates a code challenge derived from the code
verifier by using one of the following transformations on the code
verifier:
  + plain
      - code_challenge = code_verifier
  
  + S256
      - code_challenge = BASE64URL-ENCODE(SHA256(ASCII(code_verifier)))

For example in Python3:
  ```
  import random
  import string
  import base64
  import hashlib
  
  code_verifier = ''.join(random.choice(string.ascii_uppercase + string.digits) for _ in range(random.randint(43, 128)))
  
  code_challenge = hashlib.sha256(code_verifier.encode('utf-8')).digest()
  code_challenge = base64.urlsafe_b64encode(code_challenge).decode('utf-8').replace('=', '')
  ```

### Request Parameters

+ #### response_type
  _response_type_ will be set to code, indicating that the application expects to receive an _authorization code_ if successful.

+ #### client_id
  The client ID you received when you first created the application

+ #### redirect_uri (optional)
  Indicates the URL to return the user to after authorization is complete, such as https://mysite.com/api/auth

+ #### scope (optional)
  The request may have one or more _scope_ values indicating additional access requested by the application. The authorization server will need to display the requested scopes to the user.

+ #### state (recommended)
  The _state_ parameter is used by the application to store request-specific data and/or prevent CSRF attacks. The authorization server must return the unmodified _state_ value back to the application.

  A random string generated by your application, which you’ll verify later.

+ #### code_challenge (recomended)
  Instead of immediately launching a browser, the client first creates what is known as a “code verifier“. This is a cryptographically random string using the characters A-Z, a-z, 0-9, and the punctuation characters -._~ (hyphen, period, underscore, and tilde), between 43 and 128 characters long.

+ #### code_challenge_method
  Either _plain_ or _S256_, depending on whether the challenge is the plain verifier string or the SHA256 hash of the string.

For example, if the authorization server URL is https://i.gozle.com.tm/o/authorize then the client will craft a URL like the following and direct the user’s browser to it.
  ```
  https://i.gozle.com.tm/o/authorize?response_type=code
    &client_id=vW1RcAl7Mb0d5gyHNQIAcH110lWoOW2BmWJIero8
    &code_challenge=XRi41b-5yHtTojvCpXFpsLUnmGFz6xR15c3vpPANAvM
    &code_challenge_method=S256
    &state=x1234zxcghoul
    $scope=photos videos
    &redirect_uri=https://mysite.com/api/auth
  ```
For the sake of example we used https://mysite.com/api/auth as _redirect_uri_ you will get a Page not found (404) but it worked if you get a url like:
  ```
  https://mysite.com/api/auth?code=uVqLxiHDKIirldDZQfSnDsmYW1Abj2
  ```

This is the OAuth2 provider trying to give you a code. in this case ***uVqLxiHDKIirldDZQfSnDsmYW1Abj2***.

## 3. Authorization Code Exchange
The application will then exchange the authorization code for an access token. In addition to the parameters defined in Authorization Code Request , the client will also send the code_verifier parameter. 

Requst handler at https://mysite.com/api/auth should get Authorization Code from STEP 3 and send request to OAuth2 provider with that code.

A complete access token request will include the following parameters:
  ```
  grant_type=authorization_code – Indicates the grant type of this token request
  code – The client will send the authorization code it obtained in the redirect
  redirect_uri – The redirect URL that was used in the initial authorization request
  client_id – The application’s registered client ID
  code_verifier – The code verifier for the PKCE request, that the app originally generated before the authorization request.
  ```

Access token and Refresh token is retrieved from https://i.gozle.com.tm/o/token

Example url:
  ```
  https://id.gozle.com.tm/oauth/v2/auth?response_type=code
    &client_id={CLIENT_ID}
    &code={CODE}
    &code_verifier={CODE_VERIFIER}
    &redirect_uri=https://mysite.com/api/auth
    &grant_type=authorization_code
  ```

+ **CLIENT_ID** - The application’s registered client ID
+ **CODE** - _code_ returned in step 3
+ **CODE_VERIFIER** - _code_verifier_ generated in step 1

If everything went good response will be like this:
  ```
  {
    "access_token": "jooqrnOrNa0BrNWlg68u9sl6SkdFZg",
    "expires_in": 36000,
    "token_type": "Bearer",
    "scope": "read write",
    "refresh_token": "HNvDQjjsnvDySaK0miwG4lttJEl9yD"
  }
  ```

Save _access_token_ and _refresh_token_ to client database.

## 4. Accesing API with access_token

Pass _access_token_ in Authorization header:
  ```
  curl \
      -H "Authorization: Bearer jooqrnOrNa0BrNWlg68u9sl6SkdFZg" \
      -X GET https://i.gozle.com.tm/api/get_user?phone=+xxxxxxxx
  ```
## 5. Refresh access_token with refresh_token

If you’re using a JSON-based API, then it will likely return a JSON error response with the invalid_token error. In any case, the WWW-Authenticate header will also have the invalid_token error code.
  ```
  HTTP/1.1 401 Unauthorized
  WWW-Authenticate: Bearer error="invalid_token"
  error_description="The access token expired"
  Content-type: application/json
  {
    "error": "invalid_token",
    "error_description": "The access token expired"
  }
  ```

  You can refresh _access_token_ with request like this:
  ```
  https://i.gozle.com.tm/o/token?grant_type=refresh_token
    &refresh_token=xxxxxxxxxxx
    &client_id=xxxxxxxxxx
  ```

For more info visit: https://www.oauth.com/
Swagger REST docs:   https://i.gozle.com.tm/swagger

